# SUB Query

##### workshop

```
TABLE - EMP
EMPNO	ENAME	JOB			MGR	    HIREDATE	SAL		   COMM		DEPTNO
7839	KING	PRESIDENT	 -	    11/17/1981	5000		-		10
7698	BLAKE	MANAGER		7839	05/01/1981	2850		-		30
7782	CLARK	MANAGER		7839	06/09/1981	2450		-		10
7566	JONES	MANAGER		7839	04/02/1981	2975		-		20
7788	SCOTT	ANALYST		7566	12/09/1982	3000		-		20
7902	FORD	ANALYST		7566	12/03/1981	3000		-		20
7369	SMITH	CLERK		7902	12/17/1980	800			-		20
7499	ALLEN	SALESMAN	7698	02/20/1981	1600		300		30
7521	WARD	SALESMAN	7698	02/22/1981	1250		500		30
7654	MARTIN	SALESMAN	7698	09/28/1981	1250		1400	30
7844	TURNER	SALESMAN	7698	09/08/1981	1500		0		30
7876	ADAMS	CLERK		7788	01/12/1983	1100		-		20
7900	JAMES	CLERK		7698	12/03/1981	950			-		30	
7934	MILLER	CLERK		7782	01/23/1982	1300		-		10


1. 내가 속한 각 부서 별 월급 평균 이상으로 받는 직원들을 조회 하시오.

    SELECT ENAME,SAL,DEPTNO FROM EMP e1
    WHERE SAL > (SELECT AVG(SAL) FROM EMP e2
    WHERE e1.DEPTNO = e2.DEPTNO
    GROUP BY DEPTNO);
    
   

2. 직원의 정보를 조회하시오.

    SELECT e1.DEPTNO,e1.ENAME,e1.SAL,
    d.DNAME,d.LOC 
    FROM EMP e1,DEPT d
    WHERE e1.DEPTNO = d.DEPTNO


3. 내가 속한 각 부서 별 월급을 가장 많이 받는 직원들을 조회하시오.

    SELECT e1.DEPTNO,e1.ENAME,e1.SAL,
    d.DNAME,d.LOC 
    FROM EMP e1,DEPT d
    WHERE e1.DEPTNO = d.DEPTNO
    AND SAL >= (
    SELECT MAX(SAL) FROM EMP e2
    WHERE e1.DEPTNO = e2.DEPTNO
    GROUP BY DEPTNO);
	
	

4. SCOTT이 소속된 부서의 직원 정보를 조회 하시오.

    SELECT e1.DEPTNO,e1.ENAME,e1.SAL,
    d.DNAME,d.LOC 
    FROM EMP e1,DEPT d
    WHERE e1.DEPTNO = d.DEPTNO
    AND e1.DEPTNO IN (
    SELECT DEPTNO FROM EMP
    WHERE ENAME='SCOTT');
    
 

5.DALLAS에 있는 직원의 정보를 조회 하시오.

	SELECT e1.DEPTNO,e1.ENAME,e1.SAL,
	d.DNAME,d.LOC 
	FROM EMP e1,DEPT d
	WHERE e1.DEPTNO = d.DEPTNO
	AND e1.DEPTNO IN (
	SELECT DEPTNO FROM DEPT
	WHERE LOC='DALLAS');



6. 5를 EXISTS로 ( EXISTS <-> IN 비교 )

	SELECT e1.DEPTNO,e1.ENAME,e1.SAL,
	d.DNAME,d.LOC 
	FROM EMP e1,DEPT d
	WHERE e1.DEPTNO = d.DEPTNO

	---위에서 조회한사람이 EXISTS에 있냐 TRUE면 출력
	AND EXISTS (
	SELECT d2.DEPTNO FROM DEPT d2, EMP e2
	WHERE d2.DEPTNO = e2.DEPTNO
	AND LOC='DALLAS'
	AND e1.DEPTNO = e2.DEPTNO
	);


7.MANAGER인 직원을 조회하시오.

	SELECT ENAME,JOB FROM EMP
	WHERE JOB='MANAGER'

8. JONES가 속한 JOB의 직원을 조회 하시오.

	SELECT ENAME,JOB FROM EMP e1
	WHERE EXISTS (
	SELECT JOB FROM EMP e2
	WHERE ENAME = 'JONES'
	AND e1.JOB=e2.JOB
	)

	비교 EXISTS <-> IN

	SELECT ENAME,JOB FROM EMP
	WHERE JOB IN (
	SELECT JOB FROM EMP
	WHERE ENAME = 'JONES'
	)


9. JONES가 속한 JOB의 직원을 조회 하시오.
단, 직원의 부서명과 지역을 출력하시오.

	SELECT e1.ENAME,e1.JOB,d.DNAME,d.LOC FROM EMP e1, DEPT d
	WHERE EXISTS (
	SELECT JOB FROM EMP e2
	WHERE ENAME = 'JONES'
	AND e1.JOB=e2.JOB
	)
	

10. MANAGER와 SALES 직원들의 이름과 JOB을 조회 하시오.

	SELECT ENAME , JOB FROM EMP
        WHERE JOB='MANAGER'
	UNION
	SELECT ENAME,JOB FROM EMP
		WHERE JOB='SALESMAN'

	--- UNION 두 테이블의 덧셈 
	--- 주의사항 * 연산 대상이 되는 레코드의 열 수가 같을 것
	---  		* 덧셈 대상이 되는 레코드의 열이 같은 데이터형일 것
	---  		* SELECT 문은 어떤 것이든 지정할 수 있다. 단, ORDER BY 구는 마지막에 하나					 만 가능

11. 

	--- oracle 전용
	1)
	SELECT e.ENAME,d.LOC FROM 
	EMP e,DEPT d
	WHERE e.DEPTNO = d.DEPTNO

	--- 참고 e와 d의 관계 == Primary key 와 Foreign key

	--- SQL 표준
	2)
	SELECT e.ENAME,d.LOC FROM 
	EMP e INNER JOIN DEPT d
	ON (e.DEPTNO = d.DEPTNO)


12. 

	CREATE VIEW T_EMP (ENO,ENM,SAL,DNO)
	AS
 	(
	 SELECT EMPNO,ENAME,SAL,DEPTNO FROM EMP
	)

    SELECT * FROM T_EMP
    
    --- VIEW 실행하고 SELECT * FROM T_EMP 실행하면 VIEW문을 거쳐서 T_EMP가 조회됨
    --- 단, 데이터가 저장되는 것은 아님 즉, 데이터는 EMP테이블에만 존재한다.


13. 3개의 VIEW를 생성하고 조회 해보자

	---
	CREATE VIEW T_EMP (ENO,ENM,SAL,DNO)
	AS
	 (
	 SELECT EMPNO,ENAME,SAL,DEPTNO FROM EMP
	)

	---
	CREATE VIEW T_DEPT (DNO,DNM,LOC)
	AS (
	 SELECT DEPTNO, DNAME, LOC FROM DEPT
	)


	---
	T_SAL 직업 ENO,ASAL(연봉)

	CREATE VIEW T_SAL (ENO,ASAL) 
	AS(
	  SELECT EMPNO,(SAL*12)+(NVL(COMM,0)*12) FROM EMP
	)


14. 직원 정보를 조회 하시오
    ENO, ENM, SAL, ASAL, DNM, LOC

	1)
	SELECT e.ENO, e.ENM,e.sal, a.ASAL, d.DNM, d.LOC
	FROM T_EMP e, T_SAL a, T_DEPT d
	WHERE e.DNO = d.DNO
	AND e.ENO =a.ENO

	2)
	SELECT e.ENO, e.ENM,e.sal, a.ASAL, d.DNM, d.LOC
	FROM T_EMP e INNER JOIN T_DEPT d ON(e.DNO=d.DNO)
	INNER JOIN T_SAL a ON(e.ENO=a.ENO)

	1)==2) oracle vs SQL표준

14 - 1. JONES 부서원만 조회 하시오

	SELECT e.ENO, e.ENM,e.sal, a.ASAL, d.DNM, d.LOC	
	FROM T_EMP e, T_SAL a, T_DEPT d
	WHERE e.DNO = d.DNO
	AND e.ENO =a.ENO
	AND e.DNO IN (SELECT DNO FROM T_EMP WHERE ENM = 'JONES')

14 - 2. 부서 별 연봉의 평균 보다 많이 받는 직원을 조회

	SELECT e.ENO, e.ENM,e.SAL, a.ASAL, d.DNM, d.LOC
	FROM T_EMP e, T_SAL a, T_DEPT d
	WHERE e.DNO = d.DNO
	AND e.ENO =a.ENO
	AND a.ASAL >=(
	  SELECT AVG(s1.ASAL)
	  FROM T_EMP e1, T_SAL s1
	  WHERE e1.ENO = s1.ENO
	  AND e.DNO =e1.DNO
	  GROUP BY (e1.DNO)
	)


15. Self Join - 자신의 테이블을 연결한다

	직원의 정보를 출력 하시오
	EMPNO,ENAME,MNAME 을 출력하시오

	SELECT e1.EMPNO AS EMPNO,e1.ENAME AS ENAME,e2.MNAME AS MNAME
	FROM EMP e1,EMP e2
	WHERE e1.MGR=e2.EMPNO

16. Outer Join

	SELECT e.ENAME,e.JOB,d.DNAME,d.LOC
	FROM EMP e,DEPT d
	WHERE e.DEPTNO(+) = d.DEPTNO

	결과
	
	ENAME	JOB		DNAME	  LOC
	-		-	 OPERATIONS	 BOSTON

	1)
	SELECT e.ENAME,e.JOB,d.DNAME,d.LOC
	FROM EMP e,DEPT d
	WHERE e.DEPTNO = d.DEPTNO(+)

	2)
	SELECT e.ENAME,e.JOB,d.DNAME,d.LOC
	FROM EMP e LEFT OUTER JOIN DEPT d USING(DEPTNO)

	결과	
	
	ENAME	JOB		DNAME	LOC
	KSK	SALESMAN	-		-

17. RANK 함수

    SELECT ENAME, SAL,
    RANK() OVER (ORDER BY SAL DESC) AS RANKING,
    DENSE_RANK() OVER (ORDER BY SAL DESC) AS DENSE_RANKING,
    ROW_NUMBER() OVER (ORDER BY SAL DESC) AS ROW_NUMBER
    FROM EMP
    ORDER BY SAL

    결과

    ENAME	SAL	RANKING	DENSE_RANKING ROW_NUMBER
    SMITH	800		15		 13			 15
    JAMES	950		14		 12			 14
    ADAMS	1100	13		 11			 13
    MARTIN	1250	11		 10			 12
    WARD	1250	11		 10			 11
    MILLER	1300	10		 9			 10
    TURNER	1500	9		 8			 9
    ALLEN	1600	8		 7			 8
    CLARK	2450	7		 6			 7
    BLAKE	2850	6		 5			 6
    JONES	2975	5		 4			 5
    FORD	3000	3		 3			 4
    SCOTT	3000	3		 3			 3
    KSK		4000	2		 2			 2
    KING	5000	1		 1			 1
    
17-1. 5위까지 추출하자

    SELECT ENAME,SAL,ROW_NUM FROM (
  	 SELECT ENAME, SAL,
  	 ROW_NUMBER() OVER (ORDER BY SAL DESC) AS ROW_NUM
  	 FROM EMP
	 )
	 WHERE ROW_NUM<=5
	 
17-2. TOTAL COLUMN 추가 (서브쿼리 이용 : COLUMN에도 서브쿼리를 이용할 수 있다)

    SELECT ENAME,SAL,RANK,(SELECT COUNT(*) FROM EMP) AS TOTAL FROM (
       SELECT ENAME, SAL,
       RANK() OVER (ORDER BY SAL DESC) AS RANK
       FROM EMP
   	   )
       WHERE RANK<=5
       
 18. ROLLUP
 	직무별로 SUM을 구하고 그의 합을 구하자
 
 	SELECT JOB ,SUM(SAL) FROM EMP
	GROUP BY ROLLUP(JOB)
 
    합계/집계 위함 
```



